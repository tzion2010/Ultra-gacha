<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ultra Gacha v3 — Mobile-First, Stacked, Fixed Buttons</title>
<style>
  :root{
    --bg:#0a0d16;
    --panel:#131937;
    --panel-2:#1a2150;
    --accent:#8ec1ff;
    --text:#eef2ff;
    --muted:#9eabc8;
    --chip:#1c2452;
    --chip2:#222b60;
    --shadow: 0 14px 36px rgba(0,0,0,.42);
    --radius: 14px;
    --font: 16px;
    --scale: 1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    font-size: calc(var(--font) * var(--scale));
    background:
      radial-gradient(1200px 800px at 10% -10%, #2d3769 0, transparent 55%),
      radial-gradient(1000px 800px at 110% 0%, #3a256a 0, transparent 60%),
      var(--bg);
  }
  header{
    display:flex; gap:10px; align-items:center; padding:12px 14px; background:rgba(0,0,0,.25);
    position:sticky; top:0; z-index:30; backdrop-filter: blur(7px);
    border-bottom:1px solid #2b345c;
  }
  header h1{margin:0; font-size:1.05rem; letter-spacing:.5px}
  #currency{margin-left:auto; display:flex; gap:8px; align-items:center; overflow:auto; -webkit-overflow-scrolling:touch}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px; background:var(--chip); border:1px solid #3a4472; font-weight:700; white-space:nowrap}
  .pill input{width:90px; background:transparent; border:none; color:var(--text); font-weight:700; font-size:1rem}
  .btn, button{
    background: linear-gradient(180deg, #2a3669, #1a234f);
    border:1px solid #40519a;
    color:var(--text);
    padding:12px 16px; border-radius:12px; font-weight:800; cursor:pointer; min-height:44px; min-width:44px;
    touch-action: manipulation;
  }
  button:active{transform: translateY(1px)}
  button:disabled{opacity:.6; cursor:not-allowed}
  input, select, textarea{
    background:#0f152b; border:1px solid #2c355e; color:var(--text); padding:12px 14px; border-radius:12px; width:100%; font-size:1rem; min-height:44px;
  }
  label{display:block; font-size:.95rem; margin-bottom:4px}
  .small{font-size:.9rem; color:var(--muted)}
  .container{max-width:1200px; margin:14px auto; padding:0 12px 120px}
  nav.tabs{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px}
  .tab-btn{padding:10px 12px; border-radius:12px; background:var(--chip); border:1px solid #2f3965; cursor:pointer; font-weight:800}
  .tab-btn.active{outline:2px solid var(--accent); background:var(--chip2)}
  .grid{display:grid; gap:12px}
  .two{grid-template-columns: 1.2fr .8fr}
  .panel{background:linear-gradient(180deg, #151a32, #101427); border:1px solid #2b335b; border-radius:var(--radius); padding:12px; box-shadow:var(--shadow)}
  .panel h2{margin:4px 0 10px; font-size:1rem}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .row>*{flex:1}
  .card{
    background:linear-gradient(180deg, #1a2247, #0f1430);
    border:1px solid #2e3766; border-radius:16px; overflow:hidden; position:relative;
    transition:transform .08s ease;
  }
  .card:active{transform:translateY(1px)}
  .card .art{aspect-ratio: 4/5; background:#0e1126; display:flex; align-items:center; justify-content:center; overflow:hidden}
  .card .art img{width:100%; height:100%; object-fit:cover}
  .badge{
    position:absolute; top:8px; left:8px; padding:8px 10px; border-radius:10px; font-weight:800; font-size:.85rem;
    background:#111736; border:1px solid #3a4a92;
  }
  .rarity-chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:12px; background:#0f1535; border:1px solid #3d4e9c; font-weight:800; font-size:.85rem;
  }
  .stats{display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin-top:8px}
  .stat{background:#0e1331; border:1px solid #2b3565; border-radius:10px; padding:8px 10px; font-weight:800; text-align:center}
  .inv-grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap:12px}
  .kv{display:grid; grid-template-columns: 160px 1fr; gap:6px; align-items:center}
  .toast{position:fixed; bottom:16px; right:16px; background:#111735; border:1px solid #344595; padding:12px 14px; border-radius:12px; box-shadow:var(--shadow); z-index:40}
  .shop-item{display:flex; gap:12px; padding:12px; background:#12183a; border:1px solid #2a335f; border-radius:12px; align-items:center; justify-content:space-between}
  .guarantee{font-size:.9rem; color:var(--muted)}
  .hidden{display:none !important}
  .muted{color:var(--muted)}
  .divider{height:1px; background:#2a2f55; margin:10px 0}
  .flex{display:flex; gap:10px; align-items:center}
  .nowrap{white-space:nowrap}
  .right{margin-left:auto}

  /* Mobile-first stacking (Option 1) */
  @media (max-width: 900px){
    .two{grid-template-columns: 1fr}
    .container{padding:0 10px 120px}
    .inv-grid{grid-template-columns: repeat(auto-fill, minmax(150px, 1fr))}
    header{flex-wrap:wrap}
    #currency{width:100%}
    .kv{grid-template-columns: 1fr 1fr}
  }
</style>
</head>
<body>
<header>
  <h1>Ultra Gacha v3</h1>
  <div class="flex right">
    <label class="nowrap small">UI Scale
      <input id="uiScale" type="range" min="0.9" max="1.5" step="0.02" value="1" style="width:150px">
    </label>
  </div>
  <div id="currency">
    <div class="pill">💎
      <input id="gemsInput" type="number" min="0">
      <button id="gemsApply">Apply</button>
    </div>
    <div class="pill">🪙
      <input id="goldInput" type="number" min="0">
      <button id="goldApply">Apply</button>
    </div>
    <button id="dailyBtn">Daily</button>
  </div>
</header>

<div class="container">
  <nav class="tabs" role="tablist">
    <button class="tab-btn active" data-tab="gacha">Gacha</button>
    <button class="tab-btn" data-tab="inventory">Inventory</button>
    <button class="tab-btn" data-tab="shop">Shop</button>
    <button class="tab-btn" data-tab="editor">Editor</button>
    <button class="tab-btn" data-tab="tuning">Tuning</button>
    <button class="tab-btn" data-tab="database">Database</button>
    <span class="tab-btn" style="pointer-events:none; opacity:.7">v3.0</span>
  </nav>

  <section id="gacha" class="grid two">
    <div class="panel">
      <h2>Summon</h2>
      <div class="toolbar">
        <label class="nowrap">Banner:
          <select id="bannerSelect"></select>
        </label>
        <label class="nowrap">Pulls:
          <select id="pullCount">
            <option value="1">1</option>
            <option value="10">10</option>
            <option value="50">50</option>
          </select>
        </label>
        <button id="pullBtn">Pull</button>
        <span class="small">Results add to inventory.</span>
      </div>
      <div class="divider"></div>
      <div id="pullResults" class="inv-grid" style="margin-top:8px"></div>
    </div>
    <div class="panel">
      <h2>Banner Info</h2>
      <div id="bannerInfo"></div>
      <div class="divider"></div>
      <h3 style="margin:6px 0">Drop Rates</h3>
      <div id="rates"></div>
    </div>
  </section>

  <section id="inventory" class="hidden">
    <div class="panel">
      <div class="toolbar">
        <h2 style="margin-right:auto">Your Collection</h2>
        <input id="search" placeholder="Search by name..."/>
        <select id="rarityFilter"></select>
        <button id="clearFilter">Clear</button>
        <button id="exportInv" class="right">Export CSV</button>
      </div>
      <div id="inventoryGrid" class="inv-grid" style="margin-top:8px"></div>
    </div>
  </section>

  <section id="shop" class="hidden">
    <div class="grid" style="grid-template-columns: 1fr 1fr">
      <div class="panel">
        <h2>Packs</h2>
        <div id="shopPacks"></div>
      </div>
      <div class="panel">
        <h2>Quick Currency</h2>
        <div class="shop-item">
          <div>
            <div class="flex"><strong>Gem Pouch</strong><span class="muted">x1000 💎</span></div>
            <div class="guarantee">Free (dev-cheat)</div>
          </div>
          <button onclick="grantGems(1000)">Claim</button>
        </div>
        <div class="shop-item">
          <div>
            <div class="flex"><strong>Gold Stash</strong><span class="muted">x5,000 🪙</span></div>
            <div class="guarantee">Free (dev-cheat)</div>
          </div>
          <button onclick="grantGold(5000)">Claim</button>
        </div>
      </div>
    </div>
  </section>

  <section id="editor" class="hidden grid two">
    <div class="panel">
      <h2>Create / Edit Character</h2>
      <div class="row">
        <div>
          <label>Name<input id="ed_name" maxlength="50" placeholder="Name"></label>
        </div>
        <div>
          <label>Rarity<select id="ed_rarity"></select></label>
        </div>
      </div>
      <div class="row">
        <div><label>Image <input id="ed_img" type="file" accept="image/*"></label></div>
        <div class="small">Tip: square images (800×800) look great. If empty, a placeholder is generated.</div>
      </div>
      <div class="row">
        <div><label>STR<input id="ed_STR" type="number" min="1" max="30"></label></div>
        <div><label>DEX<input id="ed_DEX" type="number" min="1" max="30"></label></div>
        <div><label>CON<input id="ed_CON" type="number" min="1" max="30"></label></div>
      </div>
      <div class="row">
        <div><label>INT<input id="ed_INT" type="number" min="1" max="30"></label></div>
        <div><label>WIS<input id="ed_WIS" type="number" min="1" max="30"></label></div>
        <div><label>CHA<input id="ed_CHA" type="number" min="1" max="30"></label></div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="ed_save">Save</button>
        <button id="ed_new">New</button>
        <button id="ed_delete" class="btn danger">Delete</button>
        <span class="small">Tap a card in Editor Inventory to load.</span>
      </div>
    </div>
    <div class="panel">
      <h2>Editor Inventory</h2>
      <div id="editorInventory" class="inv-grid" style="margin-top:8px"></div>
    </div>
  </section>

  <section id="tuning" class="hidden">
    <div class="grid" style="grid-template-columns: 1fr 1fr">
      <div class="panel">
        <h2>Rarities (Editable)</h2>
        <div id="rarityEditor"></div>
        <div class="toolbar">
          <button id="addRarity">Add Rarity</button>
          <button id="saveRarities">Save Rarities</button>
        </div>
      </div>
      <div class="panel">
        <h2>Banners & Packs (Editable)</h2>
        <div id="bannerEditor"></div>
        <div class="divider"></div>
        <div id="packEditor"></div>
        <div class="toolbar">
          <button id="saveBanners">Save Banners</button>
          <button id="savePacks">Save Packs</button>
        </div>
      </div>
    </div>
    <div class="panel">
      <h2>Simulate Pulls / Sample Data</h2>
      <div class="row">
        <div><label>Banner<select id="simBanner"></select></label></div>
        <div><label>Count<input id="simCount" type="number" min="1" max="500" value="30"></label></div>
        <div class="toolbar"><button id="simRun">Simulate</button><button id="seedSample">Seed Sample DB</button></div>
      </div>
      <div class="small">Populate your save with realistic pulls.</div>
    </div>
  </section>

  <section id="database" class="hidden">
    <div class="grid two">
      <div class="panel">
        <h2>Database</h2>
        <div class="row">
          <button id="exportBtn">Export JSON</button>
          <input id="importFile" type="file" accept="application/json">
          <button id="importBtn">Import</button>
          <button id="resetBtn">Factory Reset</button>
        </div>
        <div class="small">LocalStorage save with export/import.</div>
      </div>
      <div class="panel">
        <h2>Stats</h2>
        <div id="dbStats"></div>
      </div>
    </div>
  </section>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/* ---------- Utils ---------- */
const $ = (sel, root=document)=>root.querySelector(sel);
const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
const uid = ()=>crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,8));
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const now = ()=> new Date().toISOString();
function toast(msg, ms=2200){ const t=$('#toast'); t.textContent=msg; t.classList.remove('hidden'); clearTimeout(t._timer); t._timer=setTimeout(()=>t.classList.add('hidden'), ms); }
function download(filename, text) { const el = document.createElement('a'); el.href='data:application/json;charset=utf-8,'+encodeURIComponent(text); el.download=filename; document.body.appendChild(el); el.click(); el.remove(); }
async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

/* ---------- Default Rarities (13 tiers) ---------- */
const DEFAULT_RARITIES = [
  {key:'t1_common',        grade:'F',  name:'Common',      desc:'Has no notable skills or powers.',                       color:'#a7adba', weight:.40},
  {key:'t2_uncommon',      grade:'E',  name:'Uncommon',    desc:'Possesses a useful, real-world skill.',                  color:'#7ecb92', weight:.22},
  {key:'t3_rare',          grade:'D',  name:'Rare',        desc:'Peak human or exceptional potential.',                   color:'#5fb6ff', weight:.12},
  {key:'t4_epic',          grade:'C',  name:'Epic',        desc:'Minor supernatural traits.',                             color:'#a58dff', weight:.08},
  {key:'t5_legendary',     grade:'B',  name:'Legendary',   desc:'Defined, versatile superpower.',                          color:'#ffb25b', weight:.06},
  {key:'t6_mythic',        grade:'A',  name:'Mythic',      desc:'City-block level power.',                                color:'#ffd86a', weight:.035},
  {key:'t7_supreme',       grade:'S',  name:'Supreme',     desc:'City/nation-scale influence.',                            color:'#6affc8', weight:.02},
  {key:'t8_arcane',        grade:'SS', name:'Arcane',      desc:'Reality-bending esoterica.',                             color:'#6ad5ff', weight:.012},
  {key:'t9_celestial',     grade:'SSS',name:'Celestial',   desc:'Astronomical scale.',                                    color:'#ff9ef7', weight:.008},
  {key:'t10_ultimate',     grade:'U',  name:'Ultimate',    desc:'Star-destroying, system-warping.',                       color:'#ffc86a', weight:.004},
  {key:'tx_godlike',       grade:'X',  name:'Godlike',     desc:'Breaks rules of its own universe.',                      color:'#b9fff6', weight:.0025},
  {key:'ty_multiversal',   grade:'Y',  name:'Multiversal', desc:'Exists across multiple realities.',                       color:'#fff59e', weight:.0014},
  {key:'tz_omnipotent',    grade:'Z',  name:'Omnipotent',  desc:'Absolute authority over narratives and existence.',      color:'#ffffff', weight:.0008}
];

/* ---------- DB ---------- */
const DB_KEY='ultra_gacha_v3';
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function rollStat(base){ return clamp(Math.round(base + (Math.random()*8-4)), 1, 30); }
function svgPlaceholder(name, color){
  const initials = name.split(/\s+/).map(s=>s[0]).join('').slice(0,3).toUpperCase();
  const bg = color || '#2a3150';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='1000'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0%' stop-color='${bg}'/><stop offset='100%' stop-color='#0b0f1f'/></linearGradient></defs>
    <rect width='100%' height='100%' fill='url(#g)'/>
    <g fill='#fff' font-family='Inter,Segoe UI,Arial' text-anchor='middle'>
      <text x='400' y='520' font-size='200' font-weight='800' opacity='.95'>${initials}</text>
      <text x='400' y='880' font-size='44' opacity='.85'>${name}</text>
    </g></svg>`;
  return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
}
function makeChar(name, rarityKey, rarities){
  const rar = rarities.find(r=>r.key===rarityKey) || rarities[0];
  const idx = rarities.indexOf(rar);
  const base = 8 + idx;
  const stats = ['STR','DEX','CON','INT','WIS','CHA'].reduce((o,k)=>{o[k]=rollStat(base+rand(0,10));return o;},{});
  return { id: uid(), name, rarity: rarityKey, img: svgPlaceholder(name, rar.color), stats, createdAt: now() };
}
function defaultCharacters(rarities){
  const names = [
    ['Rooftop Courier','t2_uncommon'],['Back-Alley Chemist','t2_uncommon'],
    ['Gilded Duelist','t3_rare'],['Storm Archivist','t4_epic'],['Quartz Vanguard','t3_rare'],
    ['Abyss Whisperer','t4_epic'],['Solar Bastion','t5_legendary'],['Myriad Weaver','t6_mythic'],
    ['Citybreaker Titan','t7_supreme'],['Arc-Lattice Magus','t8_arcane'],['Moonfall Seraph','t9_celestial'],
    ['Singularity Reaper','t10_ultimate'],['Pantheon Architect','tx_godlike'],['Continuum Walker','ty_multiversal'],
    ['Prime Narrator','tz_omnipotent'],['Iron Sentinel','t1_common'],['Field Ranger','t1_common']
  ];
  return names.map(([n,r])=>makeChar(n,r,rarities));
}
function addToInventory(DB, baseChar){
  const inst = { id: uid(), baseId: baseChar.id, name: baseChar.name, rarity: baseChar.rarity, img: baseChar.img, level:1, stats:{...baseChar.stats}, acquiredAt: now() };
  DB.inventory.unshift(inst);
  DB.history.unshift({ts: now(), type:'pull', char:{name:inst.name, rarity:inst.rarity}});
  return inst;
}
function normalize(weights){ const total = weights.reduce((a,b)=>a+b,0) || 1; return weights.map(w=>w/total); }
function weightedPick(weights){ const n=Math.random(); let c=0; for(let i=0;i<weights.length;i++){ c+=weights[i]; if(n<c) return i; } return weights.length-1; }
function pickRarity(DB,b){ const w=normalize(b.rates.map(r=>r.weight)); return b.rates[weightedPick(w)].key; }
function indexOfRarity(DB, key){ return DB.rarities.findIndex(r=>r.key===key); }
function simulatePulls(DB, bannerKey, count){
  const banner = DB.banners.find(b=>b.key===bannerKey) || DB.banners[0];
  const results=[];
  for(let i=0;i<count;i++){
    const rKey = pickRarity(DB, banner);
    const pool = DB.characters.filter(c=>c.rarity===rKey);
    const base = pool.length? pool[Math.floor(Math.random()*pool.length)] : DB.characters[Math.floor(Math.random()*DB.characters.length)];
    results.push(addToInventory(DB, base));
  }
  if(count>=10 && banner.pity){
    const minKey = banner.pity.tenGuaranteeKey;
    const minIndex = indexOfRarity(DB, minKey);
    const ok = results.some(r=>indexOfRarity(DB, r.rarity) >= minIndex);
    if(!ok){
      const lowIdx = results.reduce((minI, r, i)=> indexOfRarity(DB, r.rarity) < indexOfRarity(DB, results[minI].rarity) ? i : minI, 0);
      const pool = DB.characters.filter(c=>c.rarity===minKey);
      const base = pool[Math.floor(Math.random()*pool.length)] || DB.characters[0];
      results[lowIdx] = addToInventory(DB, base);
      DB.history.unshift({ts: now(), type:'pity', info:`Upgraded to ${minKey}`});
    }
  }
  return results;
}
function defaultDB(){
  const rarities = DEFAULT_RARITIES.slice();
  const characters = defaultCharacters(rarities);
  const DB = {
    createdAt: now(), lastDaily: null,
    currency:{gems:3000, gold:15000},
    rarities, characters, inventory:[], history:[],
    banners:[
      { key:'standard', name:'Standard Banner', desc:'Base weights. No guarantees.', rates: rarities.map(r=>({key:r.key, weight:r.weight})), pity:null },
      { key:'premium', name:'Premium Banner', desc:'Top-heavier. 10x guarantee: Rare+.', rates: rarities.map(r=>({key:r.key, weight: ['t3_rare','t4_epic','t5_legendary','t6_mythic','t7_supreme','t8_arcane','t9_celestial','t10_ultimate','tx_godlike','ty_multiversal','tz_omnipotent'].includes(r.key)? r.weight*1.35 : r.weight*0.8 })), pity:{tenGuaranteeKey:'t3_rare'} },
      { key:'ascended', name:'Ascended Banner', desc:'Very top-heavy. 10x guarantee: Epic+.', rates: rarities.map(r=>({key:r.key, weight: ['t4_epic','t5_legendary','t6_mythic','t7_supreme','t8_arcane','t9_celestial','t10_ultimate','tx_godlike','ty_multiversal','tz_omnipotent'].includes(r.key)? r.weight*1.8 : r.weight*0.6 })), pity:{tenGuaranteeKey:'t4_epic'} }
    ],
    packs:[
      {key:'std1', name:'Standard x1', cost:100, pulls:1, banner:'standard', guarantee:null},
      {key:'std10', name:'Standard x10', cost:900, pulls:10, banner:'standard', guarantee:null},
      {key:'pre1', name:'Premium x1', cost:250, pulls:1, banner:'premium', guarantee:null},
      {key:'pre10', name:'Premium x10', cost:2200, pulls:10, banner:'premium', guarantee:'Rare+'},
      {key:'asc10', name:'Ascended x10', cost:6000, pulls:10, banner:'ascended', guarantee:'Epic+'}
    ],
    version:3
  };
  // Seed some sample pulls so inventory is not empty
  simulatePulls(DB,'standard',8);
  simulatePulls(DB,'premium',12);
  simulatePulls(DB,'ascended',12);
  return DB;
}
function loadDB(){
  const data = localStorage.getItem(DB_KEY);
  if(!data){ const db=defaultDB(); saveDB(db); return db; }
  try{
    const db = JSON.parse(data);
    if(!db.rarities) db.rarities = DEFAULT_RARITIES.slice();
    if(!db.characters) db.characters = defaultCharacters(db.rarities);
    if(!db.banners) db.banners = defaultDB().banners;
    if(!db.packs) db.packs = defaultDB().packs;
    if(!db.currency) db.currency = {gems:0,gold:0};
    return db;
  }catch(e){ const db=defaultDB(); saveDB(db); return db; }
}
function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); updateCurrencyUI(); renderDBStats(); }
let DB = loadDB();

/* ---------- Currency ---------- */
function updateCurrencyUI(){ $('#gemsInput').value = DB.currency.gems; $('#goldInput').value = DB.currency.gold; }
function spendGems(n){ if(DB.currency.gems<n){ toast('Not enough gems!'); return false; } DB.currency.gems -= n; saveDB(DB); return true; }
function grantGems(n){ DB.currency.gems += n; saveDB(DB); toast(`+${n} 💎`); }
function grantGold(n){ DB.currency.gold += n; saveDB(DB); toast(`+${n} 🪙`); }
function canClaimDaily(){ if(!DB.lastDaily) return true; const last=new Date(DB.lastDaily); return new Date().toDateString()!==last.toDateString(); }
function claimDaily(){ if(!canClaimDaily()){ toast('Daily already claimed today.'); return; } DB.lastDaily=new Date().toISOString(); DB.currency.gems+=250; DB.currency.gold+=1000; saveDB(DB); toast('Daily: +250 💎, +1000 🪙'); }

/* ---------- Rendering ---------- */
function rarityByKey(key){ return DB.rarities.find(r=>r.key===key) || DB.rarities[0]; }
function renderCard(card){
  const rar = rarityByKey(card.rarity);
  return `<div class="card" data-id="${card.id}" title="${rar.grade} • ${rar.name}">
    <span class="badge" style="border-color:${rar.color}; color:${rar.color}">${rar.grade} • ${rar.name}</span>
    <div class="art"><img alt="" src="${card.img}"></div>
    <div style="padding:10px">
      <div class="flex" style="justify-content:space-between"><strong>${card.name}</strong><span class="small">Lv ${card.level||1}</span></div>
      <div class="stats">
        ${Object.entries(card.stats).map(([k,v])=>`<div class="stat">${k}<br>${v}</div>`).join('')}
      </div>
    </div>
  </div>`;
}
function renderInventory(list, root){ root.innerHTML = list.map(renderCard).join('') || `<div class="small">No items yet. Pull from the Gacha!</div>`; }
function renderRates(banner){
  $('#rates').innerHTML = banner.rates.map(rr=>{
    const r = rarityByKey(rr.key);
    return `<div class="row" style="align-items:center">
      <div style="min-width:220px"><span class="rarity-chip" style="border-color:${r.color}; color:${r.color}">● ${r.grade} • ${r.name}</span></div>
      <div class="kv"><div>Weight</div><div>${(rr.weight).toFixed(6)}</div></div>
    </div>`;
  }).join('');
}
function renderBanners(){
  const sel = $('#bannerSelect');
  sel.innerHTML = DB.banners.map(b=>`<option value="${b.key}">${b.name}</option>`).join('');
  const simSel = $('#simBanner'); simSel.innerHTML = sel.innerHTML;
  onBannerChange();
}
function onBannerChange(){
  const key = $('#bannerSelect').value;
  const banner = DB.banners.find(b=>b.key===key) || DB.banners[0];
  $('#bannerInfo').innerHTML = `<div>${banner.desc}</div>`;
  renderRates(banner);
}
function renderFilters(){
  const rf = $('#rarityFilter');
  rf.innerHTML = `<option value="">All rarities</option>` + DB.rarities.map(r=>`<option value="${r.key}">${r.grade} • ${r.name}</option>`).join('');
}
function renderInventoryTabs(){
  const q = $('#search').value.toLowerCase();
  const r = $('#rarityFilter').value;
  const list = DB.inventory.filter(c=>(!q || c.name.toLowerCase().includes(q)) && (!r || c.rarity===r));
  renderInventory(list, $('#inventoryGrid'));
  renderInventory(DB.inventory, $('#editorInventory'));
}
function renderDBStats(){
  const countsByR = DB.rarities.map(r=>{
    const count = DB.inventory.filter(c=>c.rarity===r.key).length;
    return `<div class="kv"><div>${r.grade} • ${r.name}</div><div>${count}</div></div>`;
  }).join('');
  $('#dbStats').innerHTML = `
    <div class="kv"><div>Total Characters</div><div>${DB.inventory.length}</div></div>
    <div class="kv"><div>Pool Size</div><div>${DB.characters.length}</div></div>
    <div class="kv"><div>Gems</div><div>${DB.currency.gems}</div></div>
    <div class="kv"><div>Gold</div><div>${DB.currency.gold}</div></div>
    <div class="divider"></div>
    ${countsByR}
  `;
}
function renderPullResults(results){ $('#pullResults').innerHTML = results.map(renderCard).join(''); }
function renderShop(){
  const root = $('#shopPacks');
  root.innerHTML = DB.packs.map(p=>{
    const b = DB.banners.find(x=>x.key===p.banner);
    const gua = p.guarantee ? `<div class="guarantee">Guarantee: ${p.guarantee}</div>`:'';
    return `<div class="shop-item">
      <div>
        <div class="flex"><strong>${p.name}</strong><span class="muted">— ${b?b.name:'?'}</span></div>
        <div class="flex"><span class="pill">Cost: 💎 ${p.cost}</span>${gua}</div>
      </div>
      <button onclick="buyPack('${p.key}')">Buy</button>
    </div>`;
  }).join('');
}

/* ---------- Actions ---------- */
function doMultiPull(bannerKey, n){ const results = simulatePulls(DB, bannerKey, n); saveDB(DB); return results; }
function buyPack(key){
  const p = DB.packs.find(x=>x.key===key);
  if(!p) return;
  if(!spendGems(p.cost)) return;
  const results = doMultiPull(p.banner, p.pulls);
  renderPullResults(results);
  toast(`Opened ${p.name}!`);
  switchTab('gacha');
  $('#bannerSelect').value = p.banner;
  onBannerChange();
}

/* ---------- Editor ---------- */
let EDITING_ID = null;
function resetEditorFields(){
  EDITING_ID = null;
  $('#ed_name').value='';
  $('#ed_rarity').value = DB.rarities[2]?.key || '';
  for(const k of ['STR','DEX','CON','INT','WIS','CHA']) $('#ed_'+k).value=10;
  $('#ed_img').value='';
}
function loadIntoEditor(invId){
  const card = DB.inventory.find(x=>x.id===invId);
  if(!card){ toast('Card not found'); return; }
  EDITING_ID = invId;
  $('#ed_name').value = card.name;
  $('#ed_rarity').value = card.rarity;
  for(const k of ['STR','DEX','CON','INT','WIS','CHA']) $('#ed_'+k).value = card.stats[k];
  $('#ed_img').value='';
  toast('Loaded.');
}
async function saveEditor(){
  const name = $('#ed_name').value.trim() || 'Unnamed';
  const rarity = $('#ed_rarity').value;
  const stats = {}; for(const k of ['STR','DEX','CON','INT','WIS','CHA']) stats[k] = clamp(parseInt($('#ed_'+k).value)||10,1,30);
  let img = null; const f = $('#ed_img').files[0]; if(f){ img = await fileToDataURL(f); }
  if(EDITING_ID){
    const card = DB.inventory.find(x=>x.id===EDITING_ID);
    if(!card) return toast('Card vanished?');
    card.name=name; card.rarity=rarity; card.stats=stats; if(img) card.img=img;
    DB.history.unshift({ts: now(), type:'edit', char:{name:card.name}});
  }else{
    const base = { id: uid(), name, rarity, stats, img: img || svgPlaceholder(name, rarityByKey(rarity).color), createdAt: now() };
    DB.characters.push(base);
    addToInventory(DB, base);
    DB.history.unshift({ts: now(), type:'create', char:{name:base.name}});
  }
  saveDB(DB); renderAll(); toast('Saved.'); resetEditorFields();
}
function deleteEditing(){
  if(!EDITING_ID){ toast('Nothing selected'); return; }
  const idx = DB.inventory.findIndex(x=>x.id===EDITING_ID);
  if(idx>=0){ DB.inventory.splice(idx,1); saveDB(DB); renderAll(); toast('Deleted.'); resetEditorFields(); }
}

/* ---------- Tuning Editors ---------- */
function renderRarityEditor(){
  const root = $('#rarityEditor');
  root.innerHTML = DB.rarities.map(r=>`
    <div class="row" style="align-items:flex-end; margin-bottom:6px">
      <div><label>Key<input data-rk="${r.key}" data-f="key" value="${r.key}"></label></div>
      <div><label>Grade<input data-rk="${r.key}" data-f="grade" value="${r.grade}"></label></div>
      <div><label>Name<input data-rk="${r.key}" data-f="name" value="${r.name}"></label></div>
      <div><label>Color<input data-rk="${r.key}" data-f="color" value="${r.color}" type="color"></label></div>
      <div><label>Weight<input data-rk="${r.key}" data-f="weight" type="number" step="0.0001" value="${r.weight}"></label></div>
      <div><label>Desc<input data-rk="${r.key}" data-f="desc" value="${r.desc||''}"></label></div>
    </div>
  `).join('');
}
function saveRaritiesFromEditor(){
  const rows = $$('#rarityEditor [data-rk]');
  const byKey = {};
  rows.forEach(el=>{
    const rk = el.getAttribute('data-rk');
    const f = el.getAttribute('data-f');
    byKey[rk] = byKey[rk] || {};
    byKey[rk][f] = (f==='weight'? parseFloat(el.value) : el.value);
  });
  DB.rarities = Object.values(byKey);
  DB.characters.forEach(c=>{ if(!DB.rarities.find(r=>r.key===c.rarity)) c.rarity = DB.rarities[0].key; });
  DB.banners.forEach(b=>{
    b.rates = DB.rarities.map(r=>{
      const existing = b.rates.find(x=>x.key===r.key);
      return {key:r.key, weight: existing? existing.weight : r.weight};
    });
  });
  saveDB(DB); renderAll(); toast('Rarities saved.');
}
function addRarityRow(){
  DB.rarities.push({key:'new_'+uid().slice(0,4), grade:'?', name:'New', desc:'', color:'#8888ff', weight:.01});
  saveDB(DB); renderRarityEditor();
}
function renderBannerEditor(){
  const root = $('#bannerEditor');
  root.innerHTML = DB.banners.map(b=>`
    <div class="panel" style="background:#0f1636; border-color:#364689; margin-bottom:8px">
      <div class="row">
        <div><label>Key<input data-bk="${b.key}" data-f="key" value="${b.key}"></label></div>
        <div><label>Name<input data-bk="${b.key}" data-f="name" value="${b.name}"></label></div>
        <div><label>Description<input data-bk="${b.key}" data-f="desc" value="${b.desc}"></label></div>
        <div><label>Pity (10x min)
          <select data-bk="${b.key}" data-f="pity">
            ${DB.rarities.map(r=>`<option ${b.pity && b.pity.tenGuaranteeKey===r.key?'selected':''} value="${r.key}">${r.grade} • ${r.name}</option>`).join('')}
          </select>
        </label></div>
      </div>
      <div class="divider"></div>
      ${DB.rarities.map(r=>{
        const rr = b.rates.find(x=>x.key===r.key) || {key:r.key, weight:r.weight};
        return `<div class="row">
          <div style="min-width:220px"><span class="rarity-chip" style="border-color:${r.color}; color:${r.color}">● ${r.grade} • ${r.name}</span></div>
          <div><label>Weight<input class="rateInput" data-bk="${b.key}" data-rk="${r.key}" type="number" step="0.0001" value="${rr.weight}"></label></div>
        </div>`;
      }).join('')}
    </div>
  `).join('');
}
function saveBannersFromEditor(){
  const bannerGroups = new Map();
  $$('#bannerEditor [data-bk]').forEach(el=>{
    const bk = el.getAttribute('data-bk');
    const f = el.getAttribute('data-f');
    bannerGroups.set(bk, bannerGroups.get(bk) || {key:bk});
    if(f==='key') bannerGroups.get(bk).key = el.value;
    if(f==='name') bannerGroups.get(bk).name = el.value;
    if(f==='desc') bannerGroups.get(bk).desc = el.value;
    if(f==='pity') bannerGroups.get(bk).pity = {tenGuaranteeKey: el.value};
  });
  const rateMap = {};
  $$('#bannerEditor .rateInput').forEach(el=>{
    const bk = el.getAttribute('data-bk'); const rk = el.getAttribute('data-rk');
    (rateMap[bk] ||= {})[rk] = parseFloat(el.value);
  });
  const banners = [];
  for(const [k, b] of bannerGroups.entries()){
    const rates = DB.rarities.map(r=>({key:r.key, weight: (rateMap[k] && rateMap[k][r.key]!=null) ? rateMap[k][r.key] : r.weight }));
    banners.push({ key:b.key, name:b.name, desc:b.desc, rates, pity:b.pity });
  }
  DB.banners = banners;
  saveDB(DB); renderAll(); toast('Banners saved.');
}
function renderPackEditor(){
  const root = $('#packEditor');
  root.innerHTML = `<div class="small">Packs</div>` + DB.packs.map(p=>`
    <div class="row" style="align-items:flex-end; margin-bottom:6px">
      <div><label>Key<input data-pk="${p.key}" data-f="key" value="${p.key}"></label></div>
      <div><label>Name<input data-pk="${p.key}" data-f="name" value="${p.name}"></label></div>
      <div><label>Cost<input data-pk="${p.key}" data-f="cost" type="number" value="${p.cost}"></label></div>
      <div><label>Pulls<input data-pk="${p.key}" data-f="pulls" type="number" value="${p.pulls}"></label></div>
      <div><label>Banner
        <select data-pk="${p.key}" data-f="banner">
          ${DB.banners.map(b=>`<option ${p.banner===b.key?'selected':''} value="${b.key}">${b.name}</option>`).join('')}
        </select>
      </label></div>
      <div><label>Guarantee<input data-pk="${p.key}" data-f="guarantee" value="${p.guarantee||''}"></label></div>
    </div>
  `).join('');
}
function savePacksFromEditor(){
  const map = new Map();
  $$('#packEditor [data-pk]').forEach(el=>{
    const pk = el.getAttribute('data-pk');
    const f = el.getAttribute('data-f');
    map.set(pk, map.get(pk) || {key:pk});
    let v = el.value; if(f==='cost'||f==='pulls') v = parseInt(v)||0;
    map.get(pk)[f] = v;
  });
  DB.packs = Array.from(map.values());
  saveDB(DB); renderShop(); toast('Packs saved.');
}

/* ---------- Tabs & Wiring ---------- */
function switchTab(key){
  $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
  ['gacha','inventory','shop','editor','tuning','database'].forEach(id=>$('#'+id).classList.toggle('hidden', id!==key));
}
function renderAll(){
  renderBanners(); renderFilters(); renderInventoryTabs(); renderDBStats(); renderShop();
  $('#ed_rarity').innerHTML = DB.rarities.map(r=>`<option value="${r.key}">${r.grade} • ${r.name}</option>`).join('');
  renderRarityEditor(); renderBannerEditor(); renderPackEditor(); updateCurrencyUI();
}
function exportInventoryCSV(){
  const rows = [['id','name','rarityKey','rarityName','grade','level','STR','DEX','CON','INT','WIS','CHA','acquiredAt']];
  DB.inventory.forEach(c=>{ const r=rarityByKey(c.rarity); rows.push([c.id,c.name,c.rarity,r.name,r.grade,c.level,c.stats.STR,c.stats.DEX,c.stats.CON,c.stats.INT,c.stats.WIS,c.stats.CHA,c.acquiredAt]); });
  const csv = rows.map(r=>r.map(x=>`"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
  download('inventory.csv', csv);
}
function seedSampleDatabase(){ DB = defaultDB(); saveDB(DB); renderAll(); toast('Sample DB seeded (with pulls).'); }

function wire(){
  // Tabs
  $$('.tab-btn').forEach(b=>b.addEventListener('click',()=>{ if(b.dataset.tab) switchTab(b.dataset.tab);}));
  // Pulls
  $('#pullBtn').addEventListener('click', ()=>{
    const bannerKey = $('#bannerSelect').value;
    const n = parseInt($('#pullCount').value);
    const results = doMultiPull(bannerKey, n);
    renderPullResults(results); renderInventoryTabs();
  });
  $('#bannerSelect').addEventListener('change', onBannerChange);
  // Inventory
  $('#search').addEventListener('input', renderInventoryTabs);
  $('#rarityFilter').addEventListener('change', renderInventoryTabs);
  $('#clearFilter').addEventListener('click', ()=>{ $('#search').value=''; $('#rarityFilter').value=''; renderInventoryTabs(); });
  $('#exportInv').addEventListener('click', exportInventoryCSV);
  // Editor
  $('#ed_save').addEventListener('click', saveEditor);
  $('#ed_new').addEventListener('click', resetEditorFields);
  $('#ed_delete').addEventListener('click', deleteEditing);
  $('#editorInventory').addEventListener('click', (e)=>{ const card=e.target.closest('.card'); if(card) loadIntoEditor(card.dataset.id); }, {passive:true});
  // Tuning
  $('#saveRarities').addEventListener('click', saveRaritiesFromEditor);
  $('#addRarity').addEventListener('click', addRarityRow);
  $('#saveBanners').addEventListener('click', saveBannersFromEditor);
  $('#savePacks').addEventListener('click', savePacksFromEditor);
  $('#simRun').addEventListener('click', ()=>{
    const key = $('#simBanner').value; const n = parseInt($('#simCount').value);
    const results = doMultiPull(key, n); renderPullResults(results); renderInventoryTabs(); toast(`Simulated ${n} pulls on ${key}.`);
  });
  $('#seedSample').addEventListener('click', seedSampleDatabase);
  // Database
  $('#exportBtn').addEventListener('click', ()=>download('ultra_gacha_db_v3.json', JSON.stringify(DB,null,2)));
  $('#importBtn').addEventListener('click', ()=>{
    const f = $('#importFile').files[0]; if(!f) return toast('Choose a file.');
    const r = new FileReader();
    r.onload = ()=>{ try{ const data=JSON.parse(r.result); if(!data.currency || !Array.isArray(data.characters) || !Array.isArray(data.inventory)){ toast('Invalid file.'); return; } DB=data; saveDB(DB); renderAll(); toast('Imported.'); }catch(e){ toast('Failed import: '+e.message); } };
    r.readAsText(f);
  });
  $('#resetBtn').addEventListener('click', ()=>{ if(!confirm('This wipes your local data. Continue?')) return; DB=defaultDB(); saveDB(DB); renderAll(); toast('Reset complete.'); });
  // Currency
  $('#gemsApply').addEventListener('click', ()=>{ DB.currency.gems=parseInt($('#gemsInput').value)||0; saveDB(DB); toast('Gems updated.'); });
  $('#goldApply').addEventListener('click', ()=>{ DB.currency.gold=parseInt($('#goldInput').value)||0; saveDB(DB); toast('Gold updated.'); });
  $('#dailyBtn').addEventListener('click', claimDaily);
  // UI scale
  $('#uiScale').addEventListener('input', (e)=>{ document.documentElement.style.setProperty('--scale', e.target.value); }, {passive:true});
}
function initialRender(){ renderAll(); resetEditorFields(); }
wire(); initialRender();
</script>
</body>
</html>
